// Start the retry sequence
                                        requestChunk2WithRetry();
                                      }
                                    };

                                    firstAudio.onerror = () => {
                                      console.error('❌ [CHAT-TTS-2CHUNK] First chunk playback error');
                                      setAudioPlayingForMessage(null);
                                    };

                                    firstAudio.play().catch(error => {
                                      console.error('❌ [CHAT-TTS-2CHUNK] Failed to play first chunk:', error);
                                      setAudioPlayingForMessage(null);
                                    });
                                  }

                                  return newMessages;
                                });
                                setMessagesLeft(data.messagesLeft);

                                // Clear voice error after 3 seconds if it was set
                                if (voiceGenerationError) {
                                  setTimeout(() => {
                                    setVoiceGenerationError(false);
                                  }, 3000);
                                }

                                // Add character to recents when user successfully sends a message
                                if (character) {
                                  addToRecents(character);
                                }
                              } else {
                                let errorMessage: Message;
                                try {
                                  const errorData = await response.json();

                                  // Handle specific error status codes
                                  if (response.status === 429) {
                                    errorMessage = { 
                                      role: 'assistant', 
                                      content: errorData.error || "I'm experiencing high demand right now. Please try again in a few moments! 🙏" 
                                    };
                                  } else if (response.status === 503) {
                                    errorMessage = { 
                                      role: 'assistant', 
                                      content: errorData.error || "I'm temporarily unavailable due to high usage. Please try again later! ⏰" 
                                    };
                                  } else {
                                    errorMessage = { 
                                      role: 'assistant', 
                                      content: errorData.error || 'Sorry, I couldn\'t generate a response right now. Please try again! 🔄' 
                                    };
                                  }
                                } catch (parseError) {