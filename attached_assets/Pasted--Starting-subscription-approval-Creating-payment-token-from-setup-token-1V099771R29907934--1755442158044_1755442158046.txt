🔧 Starting subscription approval...
🔄 Creating payment token from setup token: 1V099771R29907934
🔑 Getting PayPal access token...
🌐 PayPal Base URL: https://api.sandbox.paypal.com
🌐 PayPal Mode: sandbox
🆔 PayPal Client ID exists: true
🆔 PayPal Client ID length: 80
🆔 PayPal Client ID preview: AdI3719HoT...
🔐 PayPal Client Secret exists: true
🔐 PayPal Client Secret length: 80
🔐 PayPal Client Secret preview: EBj4g5uU8Z...
🔑 Basic auth string length: 216
🔑 Basic auth preview: QWRJMzcxOUhvVDJEMnNY...
📋 Request body: grant_type=client_credentials
📋 Request headers: [ 'Authorization', 'Content-Type', 'Accept', 'Accept-Language' ]
📡 PayPal token response status: 200
📡 PayPal token response headers: {
  'access-control-expose-headers': 'Server-Timing',
  'cache-control': 'max-age=0, no-cache, no-store, must-revalidate',
  connection: 'keep-alive',
  'content-length': '1165',
  'content-type': 'application/json',
  date: 'Sun, 17 Aug 2025 14:47:31 GMT',
  http_x_pp_az_locator: 'ccg18.slc',
  'paypal-debug-id': '502befdc35aff',
  pragma: 'no-cache',
  'server-timing': 'traceparent;desc="00-0000000000000000000502befdc35aff-6063dbd64011acd2-01"',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  traceparent: '00-0000000000000000000502befdc35aff-573c9826838e5eff-01',
  vary: 'Accept-Encoding',
  'x-paypal-token-service': 'IAAS'
}
✅ PayPal access token obtained successfully
🔧 Creating payment token with data: {
  "payment_source": {
    "token": {
      "id": "1V099771R29907934",
      "type": "SETUP_TOKEN"
    }
  }
}
✅ Payment token created successfully: {
  id: '77c320899d903101r',
  customer: { id: 'iILdYCDzJj' },
  payment_source: {
    paypal: {
      description: 'Premium subscription with 200 daily messages',
      usage_pattern: 'IMMEDIATE',
      permit_multiple_payment_tokens: false,
      usage_type: 'MERCHANT',
      customer_type: 'CONSUMER',
      email_address: 'sb-995ty34074309@personal.example.com',
      payer_id: 'RXSB98CHPUBKJ',
      name: [Object]
    }
  },
  links: [
    {
      href: 'https://api.sandbox.paypal.com/v3/vault/payment-tokens/77c320899d903101r',
      rel: 'self',
      method: 'GET',
      encType: 'application/json'
    },
    {
      href: 'https://api.sandbox.paypal.com/v3/vault/payment-tokens/77c320899d903101r',
      rel: 'delete',
      method: 'DELETE',
      encType: 'application/json'
    }
  ]
}
✅ Payment token created: 77c320899d903101r
💳 Creating immediate payment order for subscription...
🔑 Getting PayPal access token...
🌐 PayPal Base URL: https://api.sandbox.paypal.com
🌐 PayPal Mode: sandbox
🆔 PayPal Client ID exists: true
🆔 PayPal Client ID length: 80
🆔 PayPal Client ID preview: AdI3719HoT...
🔐 PayPal Client Secret exists: true
🔐 PayPal Client Secret length: 80
🔐 PayPal Client Secret preview: EBj4g5uU8Z...
🔑 Basic auth string length: 216
🔑 Basic auth preview: QWRJMzcxOUhvVDJEMnNY...
📋 Request body: grant_type=client_credentials
📋 Request headers: [ 'Authorization', 'Content-Type', 'Accept', 'Accept-Language' ]
📡 PayPal token response status: 200
📡 PayPal token response headers: {
  'access-control-expose-headers': 'Server-Timing',
  'cache-control': 'max-age=0, no-cache, no-store, must-revalidate',
  connection: 'keep-alive',
  'content-length': '1165',
  'content-type': 'application/json',
  date: 'Sun, 17 Aug 2025 14:47:33 GMT',
  http_x_pp_az_locator: 'ccg18.slc',
  'paypal-debug-id': 'd1eda7c0a045b',
  pragma: 'no-cache',
  'server-timing': 'traceparent;desc="00-0000000000000000000d1eda7c0a045b-0b359f69dcfd11ae-01"',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  traceparent: '00-0000000000000000000d1eda7c0a045b-d0e81491e5da4a76-01',
  vary: 'Accept-Encoding',
  'x-paypal-token-service': 'IAAS'
}
✅ PayPal access token obtained successfully
🔧 Creating subscription order with data: {
  "intent": "CAPTURE",
  "purchase_units": [
    {
      "amount": {
        "currency_code": "USD",
        "value": "3.88"
      },
      "description": "Premium subscription with 200 daily messages"
    }
  ],
  "payment_source": {
    "paypal": {
      "vault_id": "77c320899d903101r",
      "stored_credential": {
        "payment_initiator": "MERCHANT",
        "usage": "SUBSEQUENT",
        "usage_pattern": "RECURRING_POSTPAID"
      }
    }
  }
}
✅ Subscription order created successfully: {
  id: '2DJ771142H831890K',
  status: 'COMPLETED',
  payment_source: {
    paypal: {
      email_address: 'sb-995ty34074309@personal.example.com',
      account_id: 'RXSB98CHPUBKJ',
      account_status: 'VERIFIED',
      name: [Object],
      address: [Object],
      stored_credential: [Object]
    }
  },
  purchase_units: [ { reference_id: 'default', payments: [Object] } ],
  payer: {
    name: { given_name: 'John', surname: 'Doe' },
    email_address: 'sb-995ty34074309@personal.example.com',
    payer_id: 'RXSB98CHPUBKJ',
    address: { country_code: 'US' }
  },
  links: [
    {
      href: 'https://api.sandbox.paypal.com/v2/checkout/orders/2DJ771142H831890K',
      rel: 'self',
      method: 'GET'
    }
  ]
}
📦 Order created: 2DJ771142H831890K
✅ Order was already completed during creation (vault payment)
✅ Payment processed successfully! Order ID: 2DJ771142H831890K
💾 Saving subscription data: {
  id: 'Uc3If33kkSUSY3t4584y2K5ONQF3-premium-1755442053383',
  userId: 'Uc3If33kkSUSY3t4584y2K5ONQF3',
  planId: 'premium',
  status: 'active',
  paymentTokenId: '77c320899d903101r',
  payerInfo: {
    email: 'sb-995ty34074309@personal.example.com',
    payerId: 'RXSB98CHPUBKJ'
  },
  initialPayment: {
    orderId: '2DJ771142H831890K',
    transactionId: '2DJ771142H831890K',
    amount: 3.88,
    currency: 'USD',
    status: 'COMPLETED',
    paidAt: 2025-08-17T14:47:36.936Z
  },
  createdAt: 2025-08-17T14:47:36.936Z,
  nextBillingDate: 2025-09-16T14:47:36.936Z,
  lastChargedAt: 2025-08-17T14:47:36.936Z
}
✅ Subscription saved to Firestore
✅ User credits updated
✅ User plan upgraded to: premium
 POST /api/subscription/approve 200 in 10271ms